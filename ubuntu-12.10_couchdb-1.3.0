FROM ubuntu:12.10
EXPOSE 5984

RUN echo "deb http://us.archive.ubuntu.com/ubuntu/ quantal main restricted \n\
deb-src http://us.archive.ubuntu.com/ubuntu/ quantal main restricted \n\
deb http://us.archive.ubuntu.com/ubuntu/ quantal-updates main restricted \n\
deb-src http://us.archive.ubuntu.com/ubuntu/ quantal-updates main restricted \n\
deb http://us.archive.ubuntu.com/ubuntu/ quantal universe \n\
deb-src http://us.archive.ubuntu.com/ubuntu/ quantal universe \n\
deb http://us.archive.ubuntu.com/ubuntu/ quantal-updates universe \n\
deb-src http://us.archive.ubuntu.com/ubuntu/ quantal-updates universe \n\
deb http://us.archive.ubuntu.com/ubuntu/ quantal multiverse \n\
deb-src http://us.archive.ubuntu.com/ubuntu/ quantal multiverse \n\
deb http://us.archive.ubuntu.com/ubuntu/ quantal-updates multiverse \n\
deb-src http://us.archive.ubuntu.com/ubuntu/ quantal-updates multiverse \n\
deb http://us.archive.ubuntu.com/ubuntu/ quantal-backports main restricted universe multiverse \n\
deb-src http://us.archive.ubuntu.com/ubuntu/ quantal-backports main restricted universe multiverse \n\
deb http://security.ubuntu.com/ubuntu quantal-security main restricted \n\
deb-src http://security.ubuntu.com/ubuntu quantal-security main restricted \n\
deb http://security.ubuntu.com/ubuntu quantal-security universe \n\
deb-src http://security.ubuntu.com/ubuntu quantal-security universe \n\
deb http://security.ubuntu.com/ubuntu quantal-security multiverse \n\
deb-src http://security.ubuntu.com/ubuntu quantal-security multiverse" > /etc/apt/sources.list
RUN apt-get update
RUN apt-get install -y g++ erlang-dev erlang-manpages erlang-base-hipe erlang-eunit erlang-nox erlang-xmerl erlang-inets libmozjs185-dev libicu-dev libcurl4-gnutls-dev libtool wget make
RUN cd /tmp && wget --output-document=apache-couchdb-1.3.0.tar.gz http://archive.apache.org/dist/couchdb/source/1.3.0/apache-couchdb-1.3.0.tar.gz && tar xvzf apache-couchdb-1.3.0.tar.gz
RUN cd /tmp/apache-couchdb-* && ./configure && make && make install
RUN ln -s /usr/local/etc/logrotate.d/couchdb /etc/logrotate.d/couchdb
RUN ln -s /usr/local/etc/init.d/couchdb /etc/init.d
RUN update-rc.d couchdb defaults

CMD ["/usr/local/bin/couch"]
